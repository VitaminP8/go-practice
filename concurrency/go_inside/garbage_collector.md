### Сборщик мусора в Go

Сборка мусора (Garbage Collection, GC) — это механизм автоматического управления памятью, который освобождает память, занятую недостижимыми объектами. В Go сборка мусора играет ключевую роль в управлении памятью, особенно в контексте работы с кучей (heap). В этой заметке мы рассмотрим основные аспекты сборки мусора в Go, включая алгоритмы, этапы работы и их влияние на производительность.

---

### 1. Сборка мусора: Mark and Sweep

Алгоритм **Mark and Sweep** (Пометка и Очистка) — это один из классических подходов к сборке мусора. Он состоит из двух основных этапов:

- **Mark (Пометка)**:
    - Сборщик мусора начинает с корневых объектов (например, переменных в стеке, глобальных переменных).
    - Он проходит по всем достижимым объектам в куче и помечает их как "живые".

- **Sweep (Очистка)**:
    - После пометки сборщик проходит по всей куче и освобождает память, занятую непомеченными (недостижимыми) объектами.
    - Освобожденная память возвращается в пул свободной памяти для дальнейшего использования.


---

### 2. Сборка мусора: Three-color Marker Algorithm

В Go используется более продвинутый алгоритм, называемый **Three-color Marker Algorithm** (Алгоритм трёхцветной пометки). Этот алгоритм позволяет выполнять сборку мусора с минимальными остановками программы (STW). Основные шаги:

1. **Инициализация**:
    - Все корневые объекты (стек, глобальные переменные) помечаются как **серые**.
    - Все остальные объекты считаются **белыми** (недостижимыми).

2. **Обработка серых объектов**:
    - Сборщик выбирает серый объект и помечает его как **чёрный** (достижимый).
    - Все объекты, на которые ссылается чёрный объект, помечаются как **серые**.

3. **Повторение**:
    - Процесс повторяется, пока все серые объекты не будут обработаны.

4. **Завершение**:
    - Все оставшиеся белые объекты считаются мусором и освобождаются.


---

### 3. Сборка мусора: алгоритм

Процесс сборки мусора в Go включает следующие этапы:

1. **STW (Stop The World)**:
    - Программа временно останавливается, чтобы сборщик мусора мог безопасно пометить корневые объекты.

2. **Разметка объектов (Tricolor Algorithm)**:
    - Сборщик проходит по всем достижимым объектам и помечает их.

3. **Второй STW**:
    - Программа снова останавливается для завершения пометки и подготовки к освобождению памяти.

4. **Освобождение памяти**:
    - Недостижимые объекты освобождаются, а память возвращается в пул.

---

### 4. Сборка мусора: STW (Stop The World)

**STW (Stop The World)** — это короткая пауза в работе программы, во время которой все горутины останавливаются. Это необходимо для того, чтобы сборщик мусора мог безопасно работать с памятью.

- **Особенности STW в Go**:
    - Обычно длится очень короткое время (порядка 100 микросекунд).
    - Не ждёт горутины, находящиеся в системных вызовах (syscalls).
    - В последних версиях Go (начиная с 1.14) STW был значительно оптимизирован, что уменьшило его влияние на производительность.

---

### 5. Сборка мусора: чего это стоит?

Сборка мусора в Go имеет свои издержки:

- **Процессорное время**:
    - Сборка мусора может потреблять до 25% CPU, а в некоторых случаях и больше, если сборщик не успевает освобождать память.

- **Замедление выделения памяти**:
    - В процессе работы сборщика мусора выделение новой памяти может замедляться, так как система занята освобождением старой.

---

### 6. Сборка мусора: моменты запуска

Сборка мусора в Go запускается в следующих случаях:

1. **По времени**:
    - Сборщик мусора может запускаться через определённые интервалы времени.

2. **По количеству выделенной памяти**:
    - Если объём выделенной памяти превышает определённый порог, сборщик мусора запускается автоматически.

3. **Вручную**:
    - Программист может вручную запустить сборку мусора с помощью функции `runtime.GC()`.

---

### 7. Дополнительные аспекты

- **Поколенческая сборка мусора**:
    - В Go используется подход, при котором объекты делятся на поколения. Молодые объекты проверяются чаще, чем старые, что повышает эффективность сборки.

- **Оптимизации в последних версиях Go**:
    - Начиная с Go 1.14, были внедрены улучшения, такие как уменьшение времени STW и оптимизация алгоритмов пометки, что значительно повысило производительность.

---

### Итог

Сборка мусора в Go — это мощный механизм, который позволяет разработчикам не заботиться о ручном управлении памятью. Однако, важно понимать, как он работает, чтобы минимизировать его влияние на производительность. Сборщик мусора в Go использует современные алгоритмы, такие как Three-color Marker, и постоянно оптимизируется, чтобы уменьшить паузы (STW) и улучшить общую производительность программы.
